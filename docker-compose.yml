version: '3'

services:
  svelte-prod:
    build:
      context: .
      dockerfile: ./Dockerfile
    container_name: tidal-ui
    ports:
      - '5000:5000'   # tu pourras le commenter plus tard si tu ne veux plus d'accÃ¨s direct
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - TITLE=${TITLE}
      - REDIS_URL=${REDIS_URL}
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_USERNAME=${REDIS_USERNAME}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_TLS=${REDIS_TLS}
      - REDIS_CACHE_TTL_SECONDS=${REDIS_CACHE_TTL_SECONDS}
      - REDIS_CACHE_TTL_SEARCH_SECONDS=${REDIS_CACHE_TTL_SEARCH_SECONDS}
      - REDIS_CACHE_TTL_TRACK_SECONDS=${REDIS_CACHE_TTL_TRACK_SECONDS}
      - REDIS_CACHE_MAX_BODY_BYTES=${REDIS_CACHE_MAX_BODY_BYTES}
      - PORT=5000
    networks:
      - proxy
    labels:
      - "traefik.enable=true"

      # HTTPS
      - "traefik.http.routers.tidal.rule=Host(`flac.zpl.ovh`)"
      - "traefik.http.routers.tidal.entrypoints=websecure"
      - "traefik.http.routers.tidal.tls=true"
      - "traefik.http.routers.tidal.tls.certresolver=myresolver"
      - "traefik.http.services.tidal.loadbalancer.server.port=5000"

      # HTTP -> HTTPS
      - "traefik.http.routers.tidal-http.rule=Host(`flac.zpl.ovh`)"
      - "traefik.http.routers.tidal-http.entrypoints=web"
      - "traefik.http.routers.tidal-http.middlewares=redirect-to-https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"

networks:
  proxy:
    external: true
